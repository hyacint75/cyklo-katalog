---
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import ProductCard from "../../../../components/ProductCard.astro";
import { products } from "../../../../data/products";

export async function getStaticPaths() {
  const ITEMS_PER_PAGE = 6; // ← musí být tady

  const categories = [
    ...new Set(products.map((p) => p.category.toLowerCase())),
  ];

  const paths = [];

  for (const category of categories) {
    const categoryProducts = products.filter(
      (p) => p.category.toLowerCase() === category.toLowerCase(),
    );

    const totalPages = Math.ceil(categoryProducts.length / ITEMS_PER_PAGE);

    for (let page = 2; page <= totalPages; page++) {
      paths.push({
        params: {
          category,
          page: page.toString(),
        },
      });
    }
  }

  return paths;
}

const ITEMS_PER_PAGE = 6;

const { category, page } = Astro.params;
const currentPage = Number(page);

const categoryProducts = products.filter(
  (p) => p.category.toLowerCase() === category.toLowerCase(),
);

const totalPages = Math.ceil(categoryProducts.length / ITEMS_PER_PAGE);

if (isNaN(currentPage) || currentPage < 2 || currentPage > totalPages) {
  throw new Error("Stránka neexistuje");
}

const start = (currentPage - 1) * ITEMS_PER_PAGE;
const paginated = categoryProducts.slice(start, start + ITEMS_PER_PAGE);
---

<BaseLayout title={`Kategorie ${category} – ${currentPage}`}>
  <h1 class="text-4xl font-semibold mb-16 capitalize text-center">
    {category}
  </h1>

  <div class="grid md:grid-cols-2 xl:grid-cols-3 gap-14">
    {paginated.map((p) => <ProductCard product={p} />)}
  </div>
</BaseLayout>
